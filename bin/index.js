#!/usr/bin/env node
var e,n=(e=require("fs"))&&"object"==typeof e&&"default"in e?e.default:e,r=require("child_process"),o=require("chalk"),t=require("ora"),i=process.argv.slice(2),s=o.magenta,a=s.bold,c=o.red,u=o.green,l=o.blue,f=require("../package.json"),m="@faharmony",h=[{name:"components"},{name:"form",types:["react-select"]},{name:"helpers",types:["uuid"]},{name:"icons"},{name:"locale"},{name:"module"},{name:"router",types:["react-router-dom"]},{name:"service"},{name:"state",types:["react-redux"]},{name:"theme"},{name:"views"}],v=[{name:"core",types:["node","react"]},{name:"charts",types:["lodash"]},{name:"table",types:["react-table"]}],d=["stable","latest","snapshot","dev","rc","freeze"],p={nodeModules:process.cwd()+"/node_modules/",yarnLock:process.cwd()+"/yarn.lock"},g=n.existsSync(p.yarnLock),y=function(){return g?"yarn add":"npm install"};process.on("unhandledRejection",console.log);var P=function(e,n){return void 0===n&&(n=!0),new Promise(function(o){r.exec(e,function(e,r,t){if(e)return n&&console.error(c("error: "+e.message)),void o(!1);o(!t)})})},b=function(e){return m+"/"+e},w=function(e){try{var n=require(process.cwd()+"/package.json"),r=b(e),o=n.dependencies[r].replace("^",""),t=o.includes("RC")?"RC":o.includes("SNAPSHOT")?"SNAPSHOT":"latest";if("0.0.1"===o)return;return{version:o,tag:t,name:n.name}}catch(e){return null}},j=function(){return w("core")},S=function(){return console.log("Use param --help or -h for help.")},k=function(e){return v.find(function(n){return n.name===e})},x=function(){function e(){}return e.prototype.then=function(n,r){var o=new e,t=this.s;if(t){var i=1&t?n:r;if(i){try{I(o,1,i(this.v))}catch(e){I(o,2,e)}return o}return this}return this.o=function(e){try{var t=e.v;1&e.s?I(o,1,n?n(t):t):r?I(o,1,r(t)):I(o,2,t)}catch(e){I(o,2,e)}},o},e}();function I(e,n,r){if(!e.s){if(r instanceof x){if(!r.s)return void(r.o=I.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(I.bind(null,e,n),I.bind(null,e,2));e.s=n,e.v=r;var o=e.o;o&&o(e)}}function C(e){return e instanceof x&&1&e.s}var A="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function T(e,n,r){if("function"==typeof e[A]){var o,t,i,s=e[A]();if(function e(a){try{for(;!((o=s.next()).done||r&&r());)if((a=n(o.value))&&a.then){if(!C(a))return void a.then(e,i||(i=I.bind(null,t=new x,2)));a=a.v}t?I(t,1,a):t=a}catch(e){I(t||(t=new x),2,e)}}(),s.return){var a=function(e){try{o.done||s.return()}catch(e){}return e};if(t&&t.then)return t.then(a,function(e){throw a(e)});a()}return t}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return function(e,n,r){var o,t,i=-1;return function s(a){try{for(;++i<e.length&&(!r||!r());)if((a=n(i))&&a.then){if(!C(a))return void a.then(s,t||(t=I.bind(null,o=new x,2)));a=a.v}o?I(o,1,a):o=a}catch(e){I(o||(o=new x),2,e)}}(),o}(c,function(e){return n(c[e])},r)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var L=function(){console.log(c("A version of @faharmony/core must be installed before installing other packages. \nTry running command again with tag params or no params (for latest).")),S()},q=function(e){var n=e.pkg,r=n.name,o=n.types,i=void 0===o?[]:o,s=e.version,a=e.options,u=void 0===a?"":a;try{var l={init:"["+s+"] "+b(r),loading:"Installing ",success:"Installed ",error:"Error occurred "},f=function(e,n){try{var o=(a=t({text:l.loading,prefixText:l.init}).start(),c=b(r)+"@"+s,f=y()+" "+c+" "+u,Promise.resolve(P(f)).then(function(e){function n(){e?a.succeed(l.success):a.fail(l.error)}var r=function(){if(i.length>0){var e=i.map(function(e){return"@types/"+e}).join(" "),n=y()+" -D "+e;return Promise.resolve(P(n)).then(function(){})}}();return r&&r.then?r.then(n):n()}))}catch(e){return n()}var a,c,f;return o&&o.then?o.then(void 0,n):o}(0,function(){console.log(c((null==l?void 0:l.error)||"Error occurred."))});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},E=function(e){var n=e.packageNames,r=void 0===n?["core"]:n,o=e.version,t=void 0===o?"latest":o;try{v.forEach(function(e){var n=e.name;w(n)&&"core"!==n&&r.push(n)});var i=v.filter(function(e){return r.includes(e.name)});return Promise.resolve(P("rm -rf "+p.nodeModules+"/"+m)).then(function(){function e(){return Promise.resolve(function(e){void 0===e&&(e="latest");try{var n=j();return Promise.resolve(function(){if(n){var r=n.version;return console.log("\nCurrent version:",r),T(h,function(n){var o=w(n.name),t=o?r!==o.version?r:void 0:e,i=function(){if(t)return Promise.resolve(q({pkg:n,version:t})).then(function(){})}();if(i&&i.then)return i.then(function(){})})}L()}())}catch(e){return Promise.reject(e)}}(t)).then(function(){var e=function(){if(!g)return Promise.resolve(P("npm dedupe")).then(function(){})}();if(e&&e.then)return e.then(function(){})})}var n;n=i.map(function(e){return e.name}).join(", "),console.log(s("Installing packages:",a(n)));var r=T(i,function(e){return Promise.resolve(q({version:t,pkg:e})).then(function(){})});return r&&r.then?r.then(e):e()})}catch(e){return Promise.reject(e)}},N={tag:{param:["--tag","-t"],description:"Install specific tagged version of harmony.",values:d,usage:d[0],exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"";if(""===e)return console.log(c("Tag was not provided in command.")),console.log("[ "+d.join(", ")+" ]"),Promise.resolve();switch(e){case"latest":case"stable":return Promise.resolve(E({version:"latest"})).then(function(){});case"rc":case"freeze":return Promise.resolve(E({version:"RC"})).then(function(){});case"snapshot":case"dev":return Promise.resolve(E({version:"SNAPSHOT"})).then(function(){});default:return console.log(c("Package name is incorrect.")),S(),Promise.resolve()}}catch(e){return Promise.reject(e)}}},install:{param:["--install","-i"],description:"Install harmony's packages.",values:v.map(function(e){return e.name}).filter(function(e){return"core"!==e}),usage:"charts",exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"",n=function(){if(""===e)console.log(c("Package name was not provided in command."));else{var n=function(){var n;if("core"===e)return Promise.resolve(E({version:(null===(n=j())||void 0===n?void 0:n.version)||"latest"})).then(function(){});var r=function(){if(k(e)){var n=j(),r=k(e),o=function(){if(n&&r)return Promise.resolve(q({version:n.tag,pkg:r})).then(function(){});L()}();if(o&&o.then)return o.then(function(){})}else console.log(c("Package name is incorrect.")),S()}();return r&&r.then?r.then(function(){}):void 0}();if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},module:{param:["--module","-m"],description:"Generate harmony module using plop.",values:["a ModuleID (string with all-lowercase letters)"],usage:"sample",exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"";return""===e?(console.log(c("ModuleID was not provided in command.")),S(),Promise.resolve()):(console.log("Fetching latest module template..."),Promise.resolve(P("npm i faharmony/cli --no-save")).then(function(){return console.log(s("Initiating module generator script...")),Promise.resolve(P("npx plop --plopfile "+p.nodeModules+m+"/cli/bin/plop.js "+e,!0)).then(function(){console.log(u('New module "'+e+'" is generated.'))})}))}catch(e){return Promise.reject(e)}}},sync:{param:["--sync","-s"],description:"Synchronize current branch with template repo.",exec:function(){try{return console.log(s("Stating sync...\n")),Promise.resolve(P("git remote add upstream git@bitbucket.org:fasolutions-ondemand/fa-react-app.git")).then(function(){return Promise.resolve(P("git fetch upstream")).then(function(){return Promise.resolve(P("git merge upstream/master")).then(function(e){e?console.log(a("The app is in sync.")):console.log(s("Syncing may require resolving some merge conflicts.\nResolve the conflicts and commit the changes."))})})})}catch(e){return Promise.reject(e)}}},version:{param:["--version","-v"],description:"Check installed version of harmony",exec:function(){try{var e=j();return e?console.log(s("Installed version of harmony is \n"+a(e.version)+" (tag:"+e.tag+").")):(console.log(c("No installed version of harmony \nfound in this application.")),S()),console.log("\nHarmony is FA Solutions' framework\nfor React-based app development.\nThe CLI is made to manage harmony's \npackages and versioning in the apps.\nContributors:"),f.contributors.forEach(function(e){return console.log("  %s",e)}),Promise.resolve()}catch(e){return Promise.reject(e)}}},help:{param:["--help","-h"],description:"Displays this message.",exec:function(){try{console.log("Usage: "+a("npx faharmony/cli [param]")),console.log("where param (case-insensitive) is "+o.bold("one")+" of the following:");var e=o.green,n=o.blue;for(var r in N){var t=N[r],i=t.param,c=t.description,u=t.values,l=t.usage;console.log(s(i.join(", "))+"\t"+c),u&&console.log("  param value:\t"+n(u.join(", "))),l&&console.log("\t\t%s",e("npx faharmony/cli "+i[0]+" "+l))}return Promise.resolve()}catch(e){return Promise.reject(e)}}}},M="Welcome to FA harm☯️ny CLI ",O=M.length+4,R=Array(O).join("━"),D=(Array(O).join(" "),i.length?"Param: "+i.join(" "):"No param"),F=Array(M.length-D.length).join(" "),H="┏"+R+"┓",z="┃  "+a(M)+"  ┃",U="┗"+R+"┛",_="┃  "+D+F+"  ┃";!function(){try{var e=function(){console.log(s("\nMade with 💜 at FA Solutions Oy.")+"\n"+l("https://github.com/faharmony/cli")+"\n"+R+"━━")};console.log("\n"+H+"\n"+z+"\n"+_+"\n"+U+"\n");var n=Promise.resolve(function(){try{var e=function(){if(i.length>0){var e=i[0].trim().toLowerCase(),n={name:"",exec:function(){return Promise.resolve()}};Object.entries(N).forEach(function(r){var o=r[0],t=r[1];"string"!=typeof t&&t.param.includes(e)&&(n={name:o,exec:t.exec})});var r=function(){if(""!==n.name)return Promise.resolve(n.exec()).then(function(){});console.log(o.red.bold("Error: The command is incorrect.")),S()}();if(r&&r.then)return r.then(function(){})}else{var t=j(),s=t?Promise.resolve(E({version:t.tag})).then(function(){}):Promise.resolve(E({version:"latest"})).then(function(){});if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}()).then(function(){});n&&n.then?n.then(e):e()}catch(e){Promise.reject(e)}}();
