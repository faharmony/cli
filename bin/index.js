#!/usr/bin/env node
function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=e(require("chalk")),r=e(require("fs")),o=require("child_process"),t=process.argv.slice(2),i=n.magenta,s=i.bold,a=n.red,c=n.green,u=n.blue,l=require("../package.json"),f="@faharmony",m=[{name:"components"},{name:"globalbar"},{name:"helpers",types:["uuid"]},{name:"hooks"},{name:"icons"},{name:"layouts"},{name:"locale"},{name:"module"},{name:"navigation"},{name:"router",types:["react-router-dom"]},{name:"service"},{name:"state",types:["react-redux","webpack-env"]},{name:"theme"},{name:"views"}],v=[{name:"core",types:["node","react"]},{name:"table",types:["react-table"]},{name:"charts",types:["lodash"]},{name:"form"}],h=["stable","latest","snapshot","dev","rc","freeze"],d={nodeModules:process.cwd()+"/node_modules/",yarnLock:process.cwd()+"/yarn.lock"},p=r.existsSync(d.yarnLock),g=function(){return p?"yarn add":"npm install"},y=function(){function e(){}return e.prototype.then=function(n,r){var o=new e,t=this.s;if(t){var i=1&t?n:r;if(i){try{P(o,1,i(this.v))}catch(e){P(o,2,e)}return o}return this}return this.o=function(e){try{var t=e.v;1&e.s?P(o,1,n?n(t):t):r?P(o,1,r(t)):P(o,2,t)}catch(e){P(o,2,e)}},o},e}();function P(e,n,r){if(!e.s){if(r instanceof y){if(!r.s)return void(r.o=P.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(P.bind(null,e,n),P.bind(null,e,2));e.s=n,e.v=r;var o=e.o;o&&o(e)}}function b(e){return e instanceof y&&1&e.s}var w="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function j(e,n,r){if("function"==typeof e[w]){var o,t,i,s=e[w]();if(function e(a){try{for(;!((o=s.next()).done||r&&r());)if((a=n(o.value))&&a.then){if(!b(a))return void a.then(e,i||(i=P.bind(null,t=new y,2)));a=a.v}t?P(t,1,a):t=a}catch(e){P(t||(t=new y),2,e)}}(),s.return){var a=function(e){try{o.done||s.return()}catch(e){}return e};if(t&&t.then)return t.then(a,function(e){throw a(e)});a()}return t}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return function(e,n,r){var o,t,i=-1;return function s(a){try{for(;++i<e.length&&(!r||!r());)if((a=n(i))&&a.then){if(!b(a))return void a.then(s,t||(t=P.bind(null,o=new y,2)));a=a.v}o?P(o,1,a):o=a}catch(e){P(o||(o=new y),2,e)}}(),o}(c,function(e){return n(c[e])},r)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),process.on("unhandledRejection",console.log);var k=function(e,n,r){return void 0===n&&(n=""),void 0===r&&(r=!0),new Promise(function(t){o.exec(e,function(e,o,i){if(e)return r&&console.error(a("error: "+e.message)),void t(e.message);""!==n&&console.log(c(n+"\n")),t(o||i)})})},S=function(e){return f+"/"+e},x=function(e){return e.map(function(e){return"@types/"+e}).join(" ")},I=function(e){try{var n=require(process.cwd()+"/package.json"),r=S(e),o=n.dependencies[r].replace("^",""),t=o.includes("RC")?"RC":o.includes("SNAPSHOT")?"SNAPSHOT":"latest";if("0.0.1"===o)return;return{version:o,tag:t,name:n.name}}catch(e){return null}},A=function(){return I("core")},C=function(){return console.log("Use param --help or -h for help.")},T=function(e){return v.find(function(n){return n.name===e})},L=function(e,n){return{init:"["+(p?"Yarn":"NPM")+"] Install: "+S(e)+"@"+n,success:"‚úì Successfully installed",error:"√ó Error occurred during installation"}},N=function(){console.log(a("A version of @faharmony/core must be installed before installing other packages. \nTry running command again with tag params or no params (for latest).")),C()},E=function(e){var n=e.pkg,r=n.name,o=n.types,t=void 0===o?[]:o,s=e.version,c=e.options,u=void 0===c?"":c,l=e.messages;try{var f=function(e,n){try{var o=function(){console.log(i(null==l?void 0:l.init));var e=S(r)+"@"+s,n=g()+" "+e+" "+u;return Promise.resolve(k(n,null==l?void 0:l.success)).then(function(){var e=x(t),n=g()+" -D "+e,r=function(){if(t.length>0)return Promise.resolve(k(n)).then(function(){})}();if(r&&r.then)return r.then(function(){})})}()}catch(e){return n()}return o&&o.then?o.then(void 0,n):o}(0,function(){console.log(a((null==l?void 0:l.error)||"Error occurred."))});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},M=function(e){var n=e.packageNames,r=void 0===n?["core"]:n,o=e.version,t=void 0===o?"latest":o;try{v.forEach(function(e){var n=e.name;I(n)&&"core"!==n&&r.push(n)});var i=v.filter(function(e){return r.includes(e.name)});return Promise.resolve(k("rm -rf "+d.nodeModules+"/"+f)).then(function(){function e(){return Promise.resolve(function(e){void 0===e&&(e="latest");try{var n=A(),r=function(){if(n){var r=n.version;console.log("Version:",r,"\n");var o=j(m,function(n){function o(){var e=function(){if(s.length>0)return Promise.resolve(k(g()+" -D "+x(s))).then(function(){})}();if(e&&e.then)return e.then(function(){})}var t=n.name,i=n.types,s=void 0===i?[]:i,a=I(t),c=a?r!==a.version?r:void 0:e,u=function(){if(c)return Promise.resolve(E({pkg:n,version:c,messages:L(t,c)})).then(function(){})}();return u&&u.then?u.then(o):o()});if(o&&o.then)return o.then(function(){})}else N()}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}(t)).then(function(){var e=function(){if(!p)return Promise.resolve(k("npm dedupe")).then(function(){})}();if(e&&e.then)return e.then(function(){})})}var n=j(i,function(e){return Promise.resolve(E({version:t,pkg:e,messages:L(e.name,t)})).then(function(){})});return n&&n.then?n.then(e):e()})}catch(e){return Promise.reject(e)}},q={tag:{param:["--tag","-t"],description:"Install specific tagged version of harmony.",values:h,usage:h[0],exec:function(){try{var e=t[1]?t[1].trim().toLowerCase():"";if(""===e)return console.log(a("Tag was not provided in command.")),console.log("[ "+h.join(", ")+" ]"),Promise.resolve();switch(e){case"latest":case"stable":return Promise.resolve(M({version:"latest"})).then(function(){});case"rc":case"freeze":return Promise.resolve(M({version:"RC"})).then(function(){});case"snapshot":case"dev":return Promise.resolve(M({version:"SNAPSHOT"})).then(function(){});default:return console.log(a("Package name is incorrect.")),C(),Promise.resolve()}}catch(e){return Promise.reject(e)}}},install:{param:["--install","-i"],description:"Install harmony's packages.",values:v.map(function(e){return e.name}).filter(function(e){return"core"!==e}),usage:"table",exec:function(){try{var e=t[1]?t[1].trim().toLowerCase():"",n=function(){if(""===e)console.log(a("Package name was not provided in command."));else{var n=function(){var n;if("core"===e)return Promise.resolve(M({version:(null===(n=A())||void 0===n?void 0:n.version)||"latest"})).then(function(){});var r=function(){if(T(e)){var n=A(),r=T(e),o=function(){if(n&&r)return Promise.resolve(E({messages:L(e,n.tag),version:n.tag,pkg:r})).then(function(){});N()}();if(o&&o.then)return o.then(function(){})}else console.log(a("Package name is incorrect.")),C()}();return r&&r.then?r.then(function(){}):void 0}();if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},module:{param:["--module","-m"],description:"Generate harmony module using plop.",values:["a ModuleID (string with all-lowercase letters)"],usage:"sample",exec:function(){try{var e=function(e){return console.log(i("Initiating module generator script...")),Promise.resolve(k("npx plop --plopfile "+d.nodeModules+f+"/"+r+"/plop.js "+n,'New module "'+n+'" is generated.',!0)).then(function(){})},n=t[1]?t[1].trim().toLowerCase():"";if(""===n)return console.log(a("ModuleID was not provided in command.")),C(),Promise.resolve();var r="module",o=I(r),s=T(r);return Promise.resolve(s?Promise.resolve(E({pkg:s,version:o&&o.tag||"latest",options:"--no-save"})).then(e):e())}catch(e){return Promise.reject(e)}}},sync:{param:["--sync","-s"],description:"Synchronize current branch with template repo.",exec:function(){try{return console.log(i("Stating sync...\n")),Promise.resolve(k("git remote add upstream git@bitbucket.org:fasolutions-ondemand/fa-react-app.git")).then(function(){return Promise.resolve(k("git fetch upstream")).then(function(){return Promise.resolve(k("git merge upstream/master")).then(function(e){"Already up to date."===e?console.log(s("The app is in sync.")):console.log(i("Syncing may require resolving some merge conflicts.\nResolve the conflicts and commit the changes."))})})})}catch(e){return Promise.reject(e)}}},version:{param:["--version","-v"],description:"Check installed version of harmony",exec:function(){try{var e=A();return e?console.log(i("Installed version of harmony is \n"+s(e.version)+" (tag:"+e.tag+").")):(console.log(a("No installed version of harmony \nfound in this application.")),C()),console.log("\nHarmony is FA Solutions' framework\nfor React-based app development.\nThe CLI is made to manage harmony's \npackages and versioning in the apps.\nContributors:"),l.contributors.forEach(function(e){return console.log("  %s",e)}),Promise.resolve()}catch(e){return Promise.reject(e)}}},help:{param:["--help","-h"],description:"Displays this message.",exec:function(){try{console.log("Usage: "+s("npx faharmony/cli [param]")),console.log("where param (case-insensitive) is "+n.bold("one")+" of the following:");var e=n.green,r=n.blue;for(var o in q){var t=q[o],a=t.param,c=t.description,u=t.values,l=t.usage;console.log(i(a.join(", "))+"\t"+c),u&&console.log("  param value:\t"+r(u.join(", "))),l&&console.log("\t\t%s",e("npx faharmony/cli "+a[0]+" "+l))}return Promise.resolve()}catch(e){return Promise.reject(e)}}}},O="Welcome to FA harm‚òØÔ∏èny CLI ",R=O.length+4,D=Array(R).join("‚îÅ"),H=(Array(R).join(" "),t.length?"Param: "+t.join(" "):"No param"),z=Array(O.length-H.length).join(" "),F="‚îè"+D+"‚îì",U="‚îÉ  "+s(O)+"  ‚îÉ",_="‚îó"+D+"‚îõ",G="‚îÉ  "+H+z+"  ‚îÉ";!function(){try{var e=function(){console.log(i("\nMade with üíú at FA Solutions Oy.")+"\n"+u("https://github.com/faharmony/cli")+"\n"+D+"‚îÅ‚îÅ")};console.log("\n"+F+"\n"+U+"\n"+G+"\n"+_+"\n");var r=Promise.resolve(function(){try{var e=function(){if(t.length>0){var e=t[0].trim().toLowerCase(),r={name:"",exec:function(){return Promise.resolve()}};Object.entries(q).forEach(function(n){var o=n[0],t=n[1];"string"!=typeof t&&t.param.includes(e)&&(r={name:o,exec:t.exec})});var o=function(){if(""!==r.name)return Promise.resolve(r.exec()).then(function(){});console.log(n.red.bold("Error: The command is incorrect.")),C()}();if(o&&o.then)return o.then(function(){})}else{var i=A(),s=i?Promise.resolve(M({version:i.tag})).then(function(){}):Promise.resolve(M({version:"latest"})).then(function(){});if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}()).then(function(){});r&&r.then?r.then(e):e()}catch(e){Promise.reject(e)}}();
