#!/usr/bin/env node
function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var n=e(require("chalk")),r=e(require("fs")),o=require("child_process"),t=process.argv.slice(2),i=n.magenta,s=i.bold,a=n.red,c=n.blue,u=require("../package.json"),l="@faharmony",f=[{name:"components"},{name:"globalbar"},{name:"helpers",types:["uuid"]},{name:"hooks"},{name:"icons"},{name:"layouts"},{name:"locale"},{name:"module"},{name:"navigation"},{name:"router",types:["react-router-dom"]},{name:"service"},{name:"state",types:["react-redux","webpack-env"]},{name:"theme"},{name:"views"}],m=[{name:"core",types:["node","react"]},{name:"table",types:["react-table"]},{name:"charts",types:["lodash"]},{name:"form"}],v=["stable","latest","snapshot","dev","rc","freeze"],h={nodeModules:process.cwd()+"/node_modules/",yarnLock:process.cwd()+"/yarn.lock"},d=r.existsSync(h.yarnLock),p=function(){return d?"yarn add":"npm install"},g=function(){function e(){}return e.prototype.then=function(n,r){var o=new e,t=this.s;if(t){var i=1&t?n:r;if(i){try{y(o,1,i(this.v))}catch(e){y(o,2,e)}return o}return this}return this.o=function(e){try{var t=e.v;1&e.s?y(o,1,n?n(t):t):r?y(o,1,r(t)):y(o,2,t)}catch(e){y(o,2,e)}},o},e}();function y(e,n,r){if(!e.s){if(r instanceof g){if(!r.s)return void(r.o=y.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(y.bind(null,e,n),y.bind(null,e,2));e.s=n,e.v=r;var o=e.o;o&&o(e)}}function P(e){return e instanceof g&&1&e.s}var b="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function w(e,n,r){if("function"==typeof e[b]){var o,t,i,s=e[b]();if(function e(a){try{for(;!((o=s.next()).done||r&&r());)if((a=n(o.value))&&a.then){if(!P(a))return void a.then(e,i||(i=y.bind(null,t=new g,2)));a=a.v}t?y(t,1,a):t=a}catch(e){y(t||(t=new g),2,e)}}(),s.return){var a=function(e){try{o.done||s.return()}catch(e){}return e};if(t&&t.then)return t.then(a,function(e){throw a(e)});a()}return t}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return function(e,n,r){var o,t,i=-1;return function s(a){try{for(;++i<e.length&&(!r||!r());)if((a=n(i))&&a.then){if(!P(a))return void a.then(s,t||(t=y.bind(null,o=new g,2)));a=a.v}o?y(o,1,a):o=a}catch(e){y(o||(o=new g),2,e)}}(),o}(c,function(e){return n(c[e])},r)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),process.on("unhandledRejection",console.log);var j=function(e,n,r){return void 0===n&&(n=""),void 0===r&&(r=!0),new Promise(function(t){o.exec(e,function(e,o,i){if(e)return r&&console.error(a("error: "+e.message)),void t(e.message);""!==n&&console.log(s(n+"\n")),t(o||i)})})},k=function(e){return l+"/"+e},S=function(e){return e.map(function(e){return"@types/"+e}).join(" ")},x=function(){try{var e=require(process.cwd()+"/package.json"),n=e.dependencies["@faharmony/core"].replace("^",""),r=n.includes("RC")?"RC":n.includes("SNAPSHOT")?"SNAPSHOT":"latest";if("0.0.1"===n)return;return{version:n,tag:r,name:e.name}}catch(e){return null}},A=function(e){try{var n=require(h.nodeModules+k(e)+"/package.json"),r=n.version,o=r.includes("RC")?"RC":r.includes("SNAPSHOT")?"SNAPSHOT":"latest";return{version:r,tag:o,name:n.name}}catch(e){return null}},C=function(){return console.log("Use param --help or -h for help.")},I=function(e){return m.find(function(n){return n.name===e})},T=function(e,n){return"Installing package "+k(e)+"@"+n+" using "+(d?"Yarn":"NPM")},N=function(e,n){return k(e)+"@"+n+" installed successfully."},L=function(e,n){return{init:T(e,n),success:N(e,n)}},M=function(){console.log(a("A version of @faharmony/core must be installed before installing other packages. \nTry running command again with tag params or no params (for latest).")),C()},O=function(e){var n=e.pkg,r=n.name,o=n.types,t=void 0===o?[]:o,s=e.version,c=e.options,u=void 0===c?"":c,l=e.messages;try{var f=function(e,n){try{var o=function(){console.log(i(null==l?void 0:l.init));var e=k(r)+"@"+s,n=p()+" "+e+" "+u;return Promise.resolve(j(n,null==l?void 0:l.success)).then(function(){var e=S(t),n=p()+" "+e,r=function(){if(t.length>0)return Promise.resolve(j(n)).then(function(){})}();if(r&&r.then)return r.then(function(){})})}()}catch(e){return n()}return o&&o.then?o.then(void 0,n):o}(0,function(){console.log(a((null==l?void 0:l.error)||"Error occurred."))});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},R=function(e){var n=e.packageNames,r=void 0===n?["core"]:n,o=e.version,t=void 0===o?"latest":o;try{m.forEach(function(e){var n=e.name;A(n)&&"core"!==n&&r.push(n)});var i=m.filter(function(e){return r.includes(e.name)});return Promise.resolve(j("rm -rf "+h.nodeModules+"/"+l)).then(function(){function e(){return Promise.resolve(function(e){void 0===e&&(e="latest");try{var n=x(),r=function(){if(n){var r=w(f,function(r){function o(){var e=function(){if(s.length>0)return Promise.resolve(j(p()+" "+S(s))).then(function(){})}();if(e&&e.then)return e.then(function(){})}var t=r.name,i=r.types,s=void 0===i?[]:i,a=A(t),c=function(){if(!a)return Promise.resolve(O({pkg:r,version:e,messages:{init:T(t,e)}})).then(function(){});var o=n.version,i=function(){if(o!==a.version)return Promise.resolve(O({pkg:r,version:o,messages:{init:T(t,o)}})).then(function(){})}();return i&&i.then?i.then(function(){}):void 0}();return c&&c.then?c.then(o):o()});if(r&&r.then)return r.then(function(){})}else M()}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}(t)).then(function(){var e=function(){if(!d)return Promise.resolve(j("npm dedupe")).then(function(){})}();if(e&&e.then)return e.then(function(){})})}var n=w(i,function(e){return Promise.resolve(O({version:t,pkg:e,messages:L(e.name,t)})).then(function(){})});return n&&n.then?n.then(e):e()})}catch(e){return Promise.reject(e)}},q={tag:{param:["--tag","-t"],description:"Install specific tagged version of harmony.",values:v,usage:v[0],exec:function(){try{var e=t[1]?t[1].trim().toLowerCase():"";if(""===e)return console.log(a("Tag was not provided in command.")),console.log("[ "+v.join(", ")+" ]"),Promise.resolve();switch(e){case"latest":case"stable":return Promise.resolve(R({version:"latest"})).then(function(){});case"rc":case"freeze":return Promise.resolve(R({version:"RC"})).then(function(){});case"snapshot":case"dev":return Promise.resolve(R({version:"SNAPSHOT"})).then(function(){});default:return console.log(a("Package name is incorrect.")),C(),Promise.resolve()}}catch(e){return Promise.reject(e)}}},install:{param:["--install","-i"],description:"Install harmony's packages.",values:m.map(function(e){return e.name}).filter(function(e){return"core"!==e}),usage:"table",exec:function(){try{var e=t[1]?t[1].trim().toLowerCase():"",n=function(){if(""===e)console.log(a("Package name was not provided in command."));else{var n=function(){var n;if("core"===e)return Promise.resolve(R({version:(null===(n=x())||void 0===n?void 0:n.version)||"latest"})).then(function(){});var r=function(){if(I(e)){var n=x(),r=I(e),o=function(){if(n&&r)return Promise.resolve(O({messages:L(e,n.tag),version:n.tag,pkg:r})).then(function(){});M()}();if(o&&o.then)return o.then(function(){})}else console.log(a("Package name is incorrect.")),C()}();return r&&r.then?r.then(function(){}):void 0}();if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},module:{param:["--module","-m"],description:"Generate harmony module using plop.",values:["a ModuleID (string with all-lowercase letters)"],usage:"sample",exec:function(){try{var e=function(e){return console.log(i("Initiating module generator script...")),Promise.resolve(j("npx plop --plopfile "+h.nodeModules+l+"/"+r+"/plop.js "+n,'New module "'+n+'" is generated.',!0)).then(function(){})},n=t[1]?t[1].trim().toLowerCase():"";if(""===n)return console.log(a("ModuleID was not provided in command.")),C(),Promise.resolve();var r="module",o=A(r),s=I(r);return Promise.resolve(s?Promise.resolve(O({pkg:s,version:o&&o.tag||"latest",options:"--no-save"})).then(e):e())}catch(e){return Promise.reject(e)}}},sync:{param:["--sync","-s"],description:"Synchronize current branch with template repo.",exec:function(){try{return console.log(i("Stating sync...\n")),Promise.resolve(j("git remote add upstream git@bitbucket.org:fasolutions-ondemand/fa-react-app.git")).then(function(){return Promise.resolve(j("git fetch upstream")).then(function(){return Promise.resolve(j("git merge upstream/master")).then(function(e){"Already up to date."===e?console.log(s("The app is in sync.")):console.log(i("Syncing may require resolving some merge conflicts.\nResolve the conflicts and commit the changes."))})})})}catch(e){return Promise.reject(e)}}},version:{param:["--version","-v"],description:"Check installed version of harmony",exec:function(){try{var e=x();return e?console.log(i("Installed version of harmony is \n"+s(e.version)+" (tag:"+e.tag+").")):(console.log(a("No installed version of harmony \nfound in this application.")),C()),console.log("\nHarmony is FA Solutions' framework\nfor React-based app development.\nThe CLI is made to manage harmony's \npackages and versioning in the apps.\nContributors:"),u.contributors.forEach(function(e){return console.log("  %s",e)}),Promise.resolve()}catch(e){return Promise.reject(e)}}},help:{param:["--help","-h"],description:"Displays this message.",exec:function(){try{console.log("Usage: "+s("npx faharmony/cli [param]")),console.log("where param (case-insensitive) is "+n.bold("one")+" of the following:");var e=n.green,r=n.blue;for(var o in q){var t=q[o],a=t.param,c=t.description,u=t.values,l=t.usage;console.log(i(a.join(", "))+"\t"+c),u&&console.log("  param value:\t"+r(u.join(", "))),l&&console.log("\t\t%s",e("npx faharmony/cli "+a[0]+" "+l))}return Promise.resolve()}catch(e){return Promise.reject(e)}}}},E="Welcome to FA harmâ˜¯ï¸ny CLI ",H=E.length+4,z=Array(H).join("â”"),D=(Array(H).join(" "),t.length?"Param: "+t.join(" "):"No param"),F=Array(E.length-D.length).join(" "),U="â”"+z+"â”“",_="â”ƒ  "+s(E)+"  â”ƒ",G="â”—"+z+"â”›",W="â”ƒ  "+D+F+"  â”ƒ";!function(){try{var e=function(){console.log(i("\nMade with ðŸ’œ at FA Solutions Oy.")+"\n"+c("https://github.com/faharmony/cli")+"\n"+z+"â”â”")};console.log("\n"+U+"\n"+_+"\n"+W+"\n"+G+"\n");var r=Promise.resolve(function(){try{var e=function(){if(t.length>0){var e=t[0].trim().toLowerCase(),r={name:"",exec:function(){return Promise.resolve()}};Object.entries(q).forEach(function(n){var o=n[0],t=n[1];"string"!=typeof t&&t.param.includes(e)&&(r={name:o,exec:t.exec})});var o=function(){if(""!==r.name)return Promise.resolve(r.exec()).then(function(){});console.log(n.red.bold("Error: The command is incorrect.")),C()}();if(o&&o.then)return o.then(function(){})}else{var i=x(),s=i?Promise.resolve(R({version:i.tag})).then(function(){}):Promise.resolve(R({version:"latest"})).then(function(){});if(s&&s.then)return s.then(function(){})}}();return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}()).then(function(){});r&&r.then?r.then(e):e()}catch(e){Promise.reject(e)}}();
