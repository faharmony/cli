#!/usr/bin/env node
var e,n=(e=require("fs"))&&"object"==typeof e&&"default"in e?e.default:e,r=require("child_process"),o=require("chalk"),t=require("ora"),i=process.argv.slice(2),a=o.magenta,s=a.bold,c=o.red,u=o.green,l=o.blue,f=require("../package.json"),m="@faharmony",h=[{name:"components"},{name:"form",types:["react-select"]},{name:"helpers",types:["uuid"]},{name:"icons"},{name:"locale"},{name:"module"},{name:"router",types:["react-router-dom"]},{name:"service"},{name:"state",types:["react-redux"]},{name:"table",types:["react-table"]},{name:"theme"},{name:"views"}],v=[{name:"core",types:["node","react"]},{name:"charts",types:["lodash"]}],d=["stable","latest","snapshot","dev","rc","freeze"],p={nodeModules:process.cwd()+"/node_modules/",yarnLock:process.cwd()+"/yarn.lock"},g=n.existsSync(p.yarnLock),y=function(){return g?"yarn add":"npm install"},P=function(){function e(){}return e.prototype.then=function(n,r){var o=new e,t=this.s;if(t){var i=1&t?n:r;if(i){try{b(o,1,i(this.v))}catch(e){b(o,2,e)}return o}return this}return this.o=function(e){try{var t=e.v;1&e.s?b(o,1,n?n(t):t):r?b(o,1,r(t)):b(o,2,t)}catch(e){b(o,2,e)}},o},e}();function b(e,n,r){if(!e.s){if(r instanceof P){if(!r.s)return void(r.o=b.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(b.bind(null,e,n),b.bind(null,e,2));e.s=n,e.v=r;var o=e.o;o&&o(e)}}function w(e){return e instanceof P&&1&e.s}var j="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function S(e,n,r){if("function"==typeof e[j]){var o,t,i,a=e[j]();if(function e(s){try{for(;!((o=a.next()).done||r&&r());)if((s=n(o.value))&&s.then){if(!w(s))return void s.then(e,i||(i=b.bind(null,t=new P,2)));s=s.v}t?b(t,1,s):t=s}catch(e){b(t||(t=new P),2,e)}}(),a.return){var s=function(e){try{o.done||a.return()}catch(e){}return e};if(t&&t.then)return t.then(s,function(e){throw s(e)});s()}return t}if(!("length"in e))throw new TypeError("Object is not iterable");for(var c=[],u=0;u<e.length;u++)c.push(e[u]);return function(e,n,r){var o,t,i=-1;return function a(s){try{for(;++i<e.length&&(!r||!r());)if((s=n(i))&&s.then){if(!w(s))return void s.then(a,t||(t=b.bind(null,o=new P,2)));s=s.v}o?b(o,1,s):o=s}catch(e){b(o||(o=new P),2,e)}}(),o}(c,function(e){return n(c[e])},r)}"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),process.on("unhandledRejection",console.log);var k=function(e,n){return void 0===n&&(n=!0),new Promise(function(o){r.exec(e,function(e,r,t){if(e)return n&&console.error(c("error: "+e.message)),void o(!1);o(!t)})})},x=function(e){return m+"/"+e},I=function(e){try{var n=require(process.cwd()+"/package.json"),r=x(e),o=n.dependencies[r].replace("^",""),t=o.includes("RC")?"RC":o.includes("SNAPSHOT")?"SNAPSHOT":"latest";if("0.0.1"===o)return;return{version:o,tag:t,name:n.name}}catch(e){return null}},C=function(){return I("core")},T=function(e){return void 0===e&&(e=""),console.log(c(e)+"\nUse param --help or -h for help.")},A=function(e){return v.find(function(n){return n.name===e})},L=function(){console.log(c("A version of @faharmony/core must be installed before installing other packages. \nTry running command again with tag params or no params (for latest).")),T()},q=function(e){var n=e.pkg,r=n.name,o=n.types,i=void 0===o?[]:o,a=e.version,s=e.options,u=void 0===s?"":s;try{var l={init:"["+a+"] "+x(r),loading:"Installing ",success:"Installed ",error:"Error occurred "},f=function(e,n){try{var o=(s=t({text:l.loading,prefixText:l.init}).start(),c=x(r)+"@"+a,f=y()+" "+c+" "+u,Promise.resolve(k(f)).then(function(e){function n(){e?s.succeed(l.success):s.fail(l.error)}var r=function(){if(i.length>0){var e=i.map(function(e){return"@types/"+e}).join(" "),n=y()+" -D "+e;return Promise.resolve(k(n)).then(function(){})}}();return r&&r.then?r.then(n):n()}))}catch(e){return n()}var s,c,f;return o&&o.then?o.then(void 0,n):o}(0,function(){console.log(c((null==l?void 0:l.error)||"Error occurred."))});return Promise.resolve(f&&f.then?f.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},E=function(e){var n=e.packageNames,r=void 0===n?["core"]:n,o=e.version,t=void 0===o?"latest":o;try{v.forEach(function(e){var n=e.name;I(n)&&"core"!==n&&r.push(n)});var i=v.filter(function(e){return r.includes(e.name)});return Promise.resolve(k("rm -rf "+p.nodeModules+"/"+m)).then(function(){function e(){return Promise.resolve(function(e){void 0===e&&(e="latest");try{var n=C();return Promise.resolve(function(){if(n){var r=n.version;return console.log("\nCurrent version:",r),S(h,function(n){var o=I(n.name),t=o?r!==o.version?r:void 0:e,i=function(){if(t)return Promise.resolve(q({pkg:n,version:t})).then(function(){})}();if(i&&i.then)return i.then(function(){})})}L()}())}catch(e){return Promise.reject(e)}}(t)).then(function(){var e=function(){if(!g)return Promise.resolve(k("npm dedupe")).then(function(){})}();if(e&&e.then)return e.then(function(){})})}var n;n=i.map(function(e){return e.name}).join(", "),console.log(a("Installing packages:",s(n)));var r=S(i,function(e){return Promise.resolve(q({version:t,pkg:e})).then(function(){})});return r&&r.then?r.then(e):e()})}catch(e){return Promise.reject(e)}},N={tag:{param:["--tag","-t"],description:"Install specific tagged version of harmony.",values:d,usage:d[0],exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"";if(""===e)return console.log(c("Tag was not provided in command.")),console.log("[ "+d.join(", ")+" ]"),Promise.resolve();switch(e){case"latest":case"stable":return Promise.resolve(E({version:"latest"})).then(function(){});case"rc":case"freeze":return Promise.resolve(E({version:"RC"})).then(function(){});case"snapshot":case"dev":return Promise.resolve(E({version:"SNAPSHOT"})).then(function(){});default:return console.log(c("Package name is incorrect.")),T(),Promise.resolve()}}catch(e){return Promise.reject(e)}}},install:{param:["--install","-i"],description:"Install harmony's packages.",values:v.map(function(e){return e.name}).filter(function(e){return"core"!==e}),usage:"charts",exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"",n=function(){if(""===e)console.log(c("Package name was not provided in command."));else{var n=function(){var n;if("core"===e)return Promise.resolve(E({version:(null===(n=C())||void 0===n?void 0:n.version)||"latest"})).then(function(){});var r=function(){if(A(e)){var n=C(),r=A(e),o=function(){if(n&&r)return Promise.resolve(q({version:n.tag,pkg:r})).then(function(){});L()}();if(o&&o.then)return o.then(function(){})}else console.log(c("Package name is incorrect.")),T()}();return r&&r.then?r.then(function(){}):void 0}();if(n&&n.then)return n.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},module:{param:["--module","-m"],description:"Generate harmony module using plop.",values:["a ModuleID (string with all-lowercase letters)"],usage:"sample",exec:function(){try{var e=i[1]?i[1].trim().toLowerCase():"",n=function(){if(""!==e)return console.log("Fetching latest module template..."),Promise.resolve(k("npm i faharmony/cli --no-save")).then(function(){return console.log(a("Initiating module generator script...")),Promise.resolve(k("npx plop --plopfile "+p.nodeModules+m+"/cli/bin/plop.js "+e,!0)).then(function(){console.log(u('New module "'+e+'" is generated.'))})});T("ModuleID was not provided in command.")}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}},sync:{param:["--sync","-s"],description:"Synchronize current branch with template repo.",exec:function(){try{return console.log(a("Stating sync...\n")),Promise.resolve(k("git remote add upstream git@bitbucket.org:fasolutions-ondemand/fa-react-app.git")).then(function(){return Promise.resolve(k("git fetch upstream")).then(function(){return Promise.resolve(k("git merge upstream/master")).then(function(e){e?console.log(s("The app is in sync.")):console.log(a("Syncing may require resolving some merge conflicts.\nResolve the conflicts and commit the changes."))})})})}catch(e){return Promise.reject(e)}}},version:{param:["--version","-v"],description:"Check installed version of harmony",exec:function(){try{var e=C();return e?console.log(a("Installed version of harmony is \n"+s(e.version)+" (tag:"+e.tag+").")):T("No installed version of harmony \nfound in this application."),console.log("\nharmony CLI contributors:"),f.contributors.forEach(function(e){return console.log("- %s","string"==typeof e?e:e.name)}),Promise.resolve()}catch(e){return Promise.reject(e)}}},help:{param:["--help","-h"],description:"Displays this message.",exec:function(){try{console.log("Usage: "+s("npx faharmony/cli [param]")),console.log("where param (case-insensitive) is "+o.bold("one")+" of the following:");var e=o.green,n=o.blue;for(var r in N){var t=N[r],i=t.param,c=t.description,u=t.values,l=t.usage;console.log(a(i.join(", "))+"\t"+c),u&&console.log("  param value:\t"+n(u.join(", "))),l&&console.log("\t\t%s",e("npx faharmony/cli "+i[0]+" "+l))}return Promise.resolve()}catch(e){return Promise.reject(e)}}}},M="FA harm☯️ny (react-framework) CLI",O="Made with 💜 at FA Solutions Oy.",R=Array(O.length+1).join("━"),D=i.length?"Param: "+i.join(" "):"(No param)",z=Array(M.length-D.length).join(" ");!function(){try{var e=function(){console.log(a("\n"+O)+"\n"+l("https://github.com/faharmony/cli")+"\n"+R+"\n")};console.log("\n"+R+"\n"+s(M)+"\n"+D+z+"\n");var n=function(){if(i.length>0){var e=i[0].trim().toLowerCase(),n={name:"",exec:function(){return Promise.resolve()}};Object.entries(N).forEach(function(r){var o=r[0],t=r[1];"string"!=typeof t&&t.param.includes(e)&&(n={name:o,exec:t.exec})});var r=function(){if(""!==n.name)return Promise.resolve(n.exec()).then(function(){});T("Error: The command is incorrect.")}();if(r&&r.then)return r.then(function(){})}else{var o=C(),t=o?Promise.resolve(E({version:o.tag})).then(function(){}):Promise.resolve(E({version:"latest"})).then(function(){});if(t&&t.then)return t.then(function(){})}}();n&&n.then?n.then(e):e()}catch(e){Promise.reject(e)}}();
